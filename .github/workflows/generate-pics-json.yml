name: Generate and Commit JSON & Image Files

on:
  push:
    branches:
      - main  # Trigger on push to main branch

jobs:
  generate_and_commit:
    runs-on: ubuntu-latest  # Use the latest Ubuntu environment
    
    steps:
    - name: Checkout the repository
      uses: actions/checkout@v3  # Checkout the repository

    - name: Set up Node.js
      uses: actions/setup-node@v3  # Set up Node.js environment
      with:
        node-version: '20'  # Set the Node.js version as needed

    - name: Install dependencies
      run: npm install  # Install dependencies if needed

    - name: Run generatePicsJson.js to generate files
      run: node generatePicsJson.js  # Run your script to generate files

    - name: Find and commit generated JSON and image files
      run: |
        # Find all .json files in the root directory excluding package files
        GENERATED_JSON_FILES=$(find . -maxdepth 1 -type f -name "*.json" ! -name "package.json" ! -name "package-lock.json")
        
        # Find all .png files in IconSet/108px/ directory
        GENERATED_IMAGE_FILES_108=$(find IconSet/108px/ -type f -name "*.png")

        # Find all .png files in IconSet/120px/ directory
        GENERATED_IMAGE_FILES_120=$(find IconSet/120px/ -type f -name "*.png")

        # Merge both image file lists
        GENERATED_IMAGE_FILES="$GENERATED_IMAGE_FILES_108 $GENERATED_IMAGE_FILES_120"

        # Check if any files are found
        if [ -n "$GENERATED_JSON_FILES" ] || [ -n "$GENERATED_IMAGE_FILES" ]; then
          echo "The following files are changed:"
          echo "$GENERATED_JSON_FILES"
          echo "$GENERATED_IMAGE_FILES"

          # Set Git user details for commit
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          # Add files to Git staging area (ensure proper handling of file names with spaces)
          git add "$GENERATED_JSON_FILES"
          git add "$GENERATED_IMAGE_FILES"

          # Commit the changes
          git commit -m "Update generated JSON and image files"

          # Push changes to GitHub
          git push
        else
          echo "No JSON or image files to commit"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Use GitHub token for authentication

    - name: Clean up files in IconSet directory, keeping subdirectory files
      run: |
        # Delete files in IconSet directory but keep files in subdirectories
        find IconSet -maxdepth 1 -type f -exec rm -f {} \;
